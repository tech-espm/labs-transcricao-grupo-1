<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Transcrição — Upload e Gravação</title>

  <style>
    /* RESET */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: "Inter", Arial, sans-serif;
    }

    body {
      background-color: var(--bg);
      color: var(--text);
      line-height: 1.6;
      transition: background-color .3s, color .3s;
    }

    h1, h2, h3 {
      font-weight: 600;
      color: var(--heading);
    }

    /* TEMAS */
    :root {
      --bg: #f8f9fb;
      --text: #222;
      --heading: #111;
      --card-bg: #fff;
      --border: #ddd;
      --primary: #007bff;
      --primary-hover: #0056b3;
    }

    body.dark {
      --bg: #1e1e1e;
      --text: #ddd;
      --heading: #fff;
      --card-bg: #2a2a2a;
      --border: #444;
      --primary: #3391ff;
      --primary-hover: #5badff;
    }

    header, footer {
      background: var(--card-bg);
      border-bottom: 1px solid var(--border);
      text-align: center;
      padding: 1.5rem 1rem;
      transition: background .3s, border-color .3s;
    }
    footer {
      border-top: 1px solid var(--border);
      margin-top: 3rem;
      font-size: .9rem;
    }

    main {
      padding: 2rem 1rem;
      max-width: 900px;
      margin: 0 auto;
    }

    section {
      background: var(--card-bg);
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      border: 1px solid var(--border);
    }

    h2 {
      font-size: 1.4rem;
      margin-bottom: 1rem;
      border-left: 4px solid var(--primary);
      padding-left: .5rem;
    }

    button, label[role="button"] {
      background: var(--primary);
      color: #fff;
      border: none;
      padding: .6rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      transition: background .2s;
      font-weight: 500;
      margin: .25rem;
    }
    button:hover, label[role="button"]:hover {
      background: var(--primary-hover);
    }
    button:disabled {
      background: #999;
      cursor: not-allowed;
    }

    /* TEMA */
    .theme-toggle {
      position: absolute;
      top: 1rem;
      right: 1rem;
    }
    .switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 25px;
    }
    .switch input {
      opacity: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      inset: 0;
      background: #ccc;
      border-radius: 25px;
      transition: .3s;
    }
    .slider:before {
      content: "";
      position: absolute;
      width: 19px;
      height: 19px;
      left: 3px;
      bottom: 3px;
      background: #fff;
      border-radius: 50%;
      transition: .3s;
    }
    input:checked + .slider {
      background: var(--primary);
    }
    input:checked + .slider:before {
      transform: translateX(24px);
    }

    /* UPLOAD */
    #drop-area {
      border: 2px dashed var(--primary);
      padding: 1.5rem;
      text-align: center;
      border-radius: 8px;
      background: rgba(0,123,255,0.05);
    }

    #file-list li {
      background: var(--bg);
      padding: .5rem;
      border: 1px solid var(--border);
      margin-top: .4rem;
      border-radius: 5px;
    }

    /* PLAYER */
    #audio-player {
      margin-top: 1rem;
    }

    /* PROGRESSO */
    #progress {
      width: 100%;
      height: 10px;
      background: var(--border);
      border-radius: 5px;
      margin-top: .5rem;
      display: none;
    }
    #progress-bar {
      height: 100%;
      width: 0%;
      background: var(--primary);
      border-radius: 5px;
      transition: width .2s linear;
    }

    /* TRANSCRIÇÃO */
    #transcript {
      border: 1px solid var(--border);
      min-height: 150px;
      padding: 1rem;
      border-radius: 6px;
      background: var(--bg);
      margin-top: 1rem;
      white-space: pre-wrap;
    }
  </style>
</head>

<body>
<header>
  <h1>Transcrição</h1>
  <p>Suba um áudio ou grave diretamente pelo navegador</p>

  <div class="theme-toggle">
    <label class="switch">
      <input type="checkbox" id="theme-switch">
      <span class="slider"></span>
    </label>
  </div>
</header>

<main>

<section>
  <h2>Enviar arquivo</h2>

  <div id="drop-area">
    <label for="file-input" role="button">Selecionar arquivo</label>
    <input id="file-input" type="file" accept="audio/*" style="display:none">
    <ul id="file-list"></ul>
  </div>

  <audio id="audio-player" controls style="display:none"></audio>

  <div id="progress"><div id="progress-bar"></div></div>
</section>

<section>
  <h2>Gravar pelo navegador</h2>

  <button id="record-start">Iniciar gravação</button>
  <button id="record-pause" disabled>Pausar</button>
  <button id="record-stop" disabled>Parar</button>

  <p id="rec-status">Pronto para gravar</p>
</section>

<section>
  <h2>Transcrição</h2>
  <button id="submit-transcription" disabled>Enviar para transcrição</button>

  <div id="transcript">
    <p>Nenhuma transcrição ainda.</p>
  </div>
</section>

</main>

<footer>
  © <span id="year"></span> — Todos os direitos reservados
</footer>

<script>

document.getElementById("year").textContent = new Date().getFullYear();

const themeSwitch = document.getElementById("theme-switch");
const savedTheme = localStorage.getItem("theme");
if (savedTheme === "dark") {
  document.body.classList.add("dark");
  themeSwitch.checked = true;
}
themeSwitch.addEventListener("change", () => {
  document.body.classList.toggle("dark");
  localStorage.setItem("theme", themeSwitch.checked ? "dark" : "light");
});

const fileInput = document.getElementById("file-input");
const fileList = document.getElementById("file-list");
const audioPlayer = document.getElementById("audio-player");
const submitBtn = document.getElementById("submit-transcription");
const transcriptBox = document.getElementById("transcript");

const progress = document.getElementById("progress");
const progressBar = document.getElementById("progress-bar");

let audioBlob = null;

fileInput.addEventListener("change", () => {
  const file = fileInput.files[0];
  if (!file) return;

  fileList.innerHTML = `<li>${file.name}</li>`;
  audioPlayer.src = URL.createObjectURL(file);
  audioPlayer.style.display = "block";

  audioBlob = file;
  submitBtn.disabled = false;
});


const recStatus = document.getElementById("rec-status");
const recordStart = document.getElementById("record-start");
const recordPause = document.getElementById("record-pause");
const recordStop = document.getElementById("record-stop");

let mediaRecorder;
let chunks = [];
let isPaused = false;
let timerInterval;
let seconds = 0;

function updateTimer() {
  seconds++;
  recStatus.textContent = "Gravando... " + seconds + "s";
}

recordStart.onclick = async () => {
  chunks = [];
  seconds = 0;

  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  mediaRecorder = new MediaRecorder(stream);

  mediaRecorder.ondataavailable = e => chunks.push(e.data);

  mediaRecorder.onstop = () => {
    audioBlob = new Blob(chunks, { type: "audio/webm" });
    audioPlayer.src = URL.createObjectURL(audioBlob);
    audioPlayer.style.display = "block";
    submitBtn.disabled = false;

    recStatus.textContent = "Gravação finalizada";
    clearInterval(timerInterval);
  };

  mediaRecorder.start();
  recStatus.textContent = "Gravando... 0s";

  timerInterval = setInterval(updateTimer, 1000);

  recordPause.disabled = false;
  recordStop.disabled = false;
  recordStart.disabled = true;
};

recordPause.onclick = () => {
  if (!isPaused) {
    mediaRecorder.pause();
    clearInterval(timerInterval);
    recStatus.textContent = "Pausado";
    recordPause.textContent = "Retomar";
  } else {
    mediaRecorder.resume();
    timerInterval = setInterval(updateTimer, 1000);
    recordPause.textContent = "Pausar";
    recStatus.textContent = "Gravando... " + seconds + "s";
  }
  isPaused = !isPaused;
};

recordStop.onclick = () => {
  mediaRecorder.stop();
  clearInterval(timerInterval);

  recordStart.disabled = false;
  recordPause.disabled = true;
  recordStop.disabled = true;

  recordPause.textContent = "Pausar";
  isPaused = false;
};

submitBtn.addEventListener("click", () => {
  if (!audioBlob) return;

  progress.style.display = "block";
  progressBar.style.width = "0%";

  transcriptBox.innerHTML = "<p>Processando...</p>";

  const form = new FormData();
  form.append("audio", audioBlob, "audio.webm");

  const xhr = new XMLHttpRequest();
  xhr.open("POST", "http://localhost:5000/upload-audio");

  xhr.upload.onprogress = e => {
    if (e.lengthComputable) {
      const pct = (e.loaded / e.total) * 100;
      progressBar.style.width = pct + "%";
    }
  };

  xhr.onload = () => {
    const res = JSON.parse(xhr.responseText);
    progress.style.display = "none";

    if (xhr.status === 200) {
      transcriptBox.textContent = res.transcricao;
    } else {
      transcriptBox.textContent = "Erro: " + res.erro;
    }
  };

  xhr.send(form);
});
</script>

</body>
</html>
